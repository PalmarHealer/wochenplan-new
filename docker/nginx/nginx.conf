# Nginx Configuration for Wochenplan
# This configuration includes comprehensive access logging and security settings

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ===========================================================================
    # LOGGING CONFIGURATION
    # ===========================================================================

    # Extended log format with security-relevant information
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    # JSON log format for easier parsing and analysis
    log_format json_combined escape=json
        '{'
            '"time_local":"$time_local",'
            '"remote_addr":"$remote_addr",'
            '"remote_user":"$remote_user",'
            '"request":"$request",'
            '"status": "$status",'
            '"body_bytes_sent":"$body_bytes_sent",'
            '"request_time":"$request_time",'
            '"http_referrer":"$http_referer",'
            '"http_user_agent":"$http_user_agent",'
            '"http_x_forwarded_for":"$http_x_forwarded_for",'
            '"request_method":"$request_method",'
            '"request_uri":"$request_uri",'
            '"server_protocol":"$server_protocol",'
            '"ssl_protocol":"$ssl_protocol",'
            '"ssl_cipher":"$ssl_cipher",'
            '"upstream_response_time":"$upstream_response_time",'
            '"request_id":"$request_id"'
        '}';

    # Security-focused log format (for WAF/IDS integration)
    log_format security '$time_iso8601 $remote_addr $request_method $request_uri '
                        '$status $body_bytes_sent $request_time '
                        '"$http_user_agent" "$http_referer" '
                        '"$http_cookie" "$http_x_forwarded_for"';

    # Access logs - use json format for production
    access_log /var/log/nginx/access.log json_combined;

    # Security log for suspicious patterns
    access_log /var/log/nginx/security.log security;

    # ===========================================================================
    # SECURITY SETTINGS
    # ===========================================================================

    # Hide nginx version
    server_tokens off;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # ===========================================================================
    # PERFORMANCE SETTINGS
    # ===========================================================================

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/xml+rss text/javascript application/x-javascript;

    # ===========================================================================
    # RATE LIMITING
    # ===========================================================================

    # Rate limit zone for general requests
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

    # Rate limit zone for login attempts
    limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

    # Rate limit zone for API endpoints
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;

    # Connection limit
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # ===========================================================================
    # UPSTREAM CONFIGURATION
    # ===========================================================================

    upstream php-fpm {
        server app:9000;
    }

    # ===========================================================================
    # SERVER BLOCK
    # ===========================================================================

    server {
        listen 80;
        listen [::]:80;
        server_name _;

        # Redirect HTTP to HTTPS in production
        # return 301 https://$server_name$request_uri;

        root /var/www/html/public;
        index index.php;

        # Connection limits
        limit_conn conn_limit 20;

        # ===========================================================================
        # SECURITY: Block suspicious patterns
        # ===========================================================================

        # Block access to hidden files (except .well-known)
        location ~ /\.(?!well-known) {
            deny all;
            access_log /var/log/nginx/blocked.log security;
        }

        # Block common exploit paths
        location ~* (\.php\.bak|\.php~|\.php\.swp|\.php\.orig)$ {
            deny all;
            access_log /var/log/nginx/blocked.log security;
        }

        # Block shell/webshell patterns
        location ~* (shell|c99|r57|webshell|cmd|eval|base64_decode|phpinfo)\.php$ {
            deny all;
            access_log /var/log/nginx/blocked.log security;
            return 444;
        }

        # Block SQL injection attempts in URI
        location ~* (union.*select|select.*from|insert.*into|delete.*from|drop.*table) {
            deny all;
            access_log /var/log/nginx/blocked.log security;
            return 444;
        }

        # ===========================================================================
        # RATE LIMITING: Apply to specific endpoints
        # ===========================================================================

        # Rate limit login endpoint
        location = /login {
            limit_req zone=login burst=5 nodelay;
            try_files $uri $uri/ /index.php?$query_string;
        }

        # Rate limit Livewire update endpoint (attack vector for CVE-2025-54068)
        location = /livewire/update {
            limit_req zone=login burst=10 nodelay;

            # Log all requests to this endpoint for monitoring
            access_log /var/log/nginx/livewire.log security;

            # Block requests with suspicious small response sizes
            # Note: This requires additional lua module for response size checking

            try_files $uri $uri/ /index.php?$query_string;
        }

        # Rate limit API endpoints
        location ^~ /api/ {
            limit_req zone=api burst=50 nodelay;
            try_files $uri $uri/ /index.php?$query_string;
        }

        # ===========================================================================
        # STATIC FILES
        # ===========================================================================

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml|woff|woff2|ttf|svg|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # ===========================================================================
        # PHP HANDLING
        # ===========================================================================

        location / {
            limit_req zone=general burst=20 nodelay;
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php-fpm;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;

            # Pass real IP to PHP
            fastcgi_param REMOTE_ADDR $http_x_forwarded_for;

            # Security headers for PHP responses
            add_header X-Request-Id $request_id always;
        }

        # ===========================================================================
        # HEALTH CHECK
        # ===========================================================================

        location = /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }

    # ===========================================================================
    # HTTPS SERVER (uncomment for production)
    # ===========================================================================

    # server {
    #     listen 443 ssl http2;
    #     listen [::]:443 ssl http2;
    #     server_name your-domain.com;
    #
    #     ssl_certificate /etc/nginx/ssl/fullchain.pem;
    #     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    #     ssl_session_timeout 1d;
    #     ssl_session_cache shared:SSL:50m;
    #     ssl_session_tickets off;
    #
    #     # Modern TLS configuration
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    #     ssl_prefer_server_ciphers off;
    #
    #     # HSTS
    #     add_header Strict-Transport-Security "max-age=63072000" always;
    #
    #     # ... (same location blocks as above)
    # }
}
